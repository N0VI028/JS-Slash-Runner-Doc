# 获取世界书

<CustomTOC />

## getLorebooks

获取世界书列表。

```typescript
function getLorebooks(): string[];
```

### 返回值

- **世界书名称列表**: `string[]`

## getLorebookEntries

获取世界书中的条目信息。

:::code-group

```typescript [getLorebookEntries]
function getLorebookEntries(lorebook: string): Promise<LorebookEntry[]>;
```

```typescript [GetLorebookEntriesOption]
interface GetLorebookEntriesOption {
  filter?: "none" | Partial<LorebookEntry>; // 按照指定字段值筛选条目
}
```

```typescript [LorebookEntry]
interface LorebookEntry {
  uid: number; // uid 是相对于世界书内部的，不要跨世界书使用
  display_index: number; // 酒馆中将排序设置为 "自定义" 时的显示顺序

  comment: string;
  enabled: boolean;
  type: "constant" | "selective" | "vectorized";
  position:
    | "before_character_definition" // 角色定义之前
    | "after_character_definition" // 角色定义之后
    | "before_example_messages" // 示例消息之前
    | "after_example_messages" // 示例消息之后
    | "before_author_note" // 作者注释之前
    | "after_author_note" // 作者注释之后
    | "at_depth_as_system" // @D⚙
    | "at_depth_as_assistant" // @D👤
    | "at_depth_as_user"; // @D🤖
  depth: number | null; // 仅对于 `position === 'at_depth_as_???'` 有意义；其他情况为 null
  order: number;
  probability: number;

  keys: string[];
  logic: "and_any" | "and_all" | "not_all" | "not_any";
  filters: string[];

  scan_depth: "same_as_global" | number;
  case_sensitive: "same_as_global" | boolean;
  match_whole_words: "same_as_global" | boolean;
  use_group_scoring: "same_as_global" | boolean;
  automation_id: string | null;

  exclude_recursion: boolean;
  prevent_recursion: boolean;
  delay_until_recursion: boolean | number; // 启用则是 true, 如果设置了具体的 Recursion Level 则是数字

  content: string;

  group: string;
  group_prioritized: boolean;
  group_weight: number;
  sticky: number | null;
  cooldown: number | null;
  delay: number | null;
}
```

:::

### 参数

#### `lorebook`

- **类型**: `string`
- **描述**: 世界书名称

:::warning
注意：类型定义中 `getLorebookEntries` 不再接受 `option` 参数，为了保持兼容性，如果需要筛选，请获取所有条目后自行筛选。
:::

### 示例

:::code-group

```typescript [获取所有条目]
// 获取世界书中所有条目的所有信息
const entries = await getLorebookEntries("eramgt少女歌剧");
```

```typescript [按内容筛选]
// 按内容筛选，content 中必须出现 `'神乐光'`
const entries = await getLorebookEntries("eramgt少女歌剧");
const filteredEntries = entries.filter(entry => entry.content.includes("神乐光"));
```

:::

## getLorebookSettings

获取当前的世界书全局设置。

:::code-group

```typescript [getLorebookSettings]
function getLorebookSettings(): LorebookSettings;
```

```typescript [LorebookSettings]
interface LorebookSettings {
  selected_global_lorebooks: string[];

  scan_depth: number;
  context_percentage: number;
  budget_cap: number; // 0 表示禁用
  min_activations: number;
  max_depth: number; // 0 表示无限制
  max_recursion_steps: number;

  include_names: boolean;
  recursive: boolean;
  case_sensitive: boolean;
  match_whole_words: boolean;
  use_group_scoring: boolean;
  overflow_alert: boolean;

  insertion_strategy: "evenly" | "character_first" | "global_first";
}
```

:::

### 返回值

- **selected_global_lorebooks**: `string[]`
- **scan_depth**: `number`
- **context_percentage**: `number`
- **budget_cap**: `number`
- **min_activations**: `number`
- **max_depth**: `number`
- **max_recursion_steps**: `number`
- **include_names**: `boolean`
- **recursive**: `boolean`
- **case_sensitive**: `boolean`
- **match_whole_words**: `boolean`
- **use_group_scoring**: `boolean`
- **overflow_alert**: `boolean`
- **insertion_strategy**: `"evenly" | "character_first" | "global_first"`

### 示例

```typescript
// 获取全局启用的世界书
const settings = getLorebookSettings();
alert(settings.selected_global_lorebooks);
```

## getCharLorebooks

获取角色卡绑定的世界书。

:::code-group

```typescript [getCharLorebooks]
function getCharLorebooks({ name, type }?: GetCharLorebooksOption): CharLorebooks;
```

```typescript [CharLorebooks]
interface CharLorebooks {
  primary: string | null;
  additional: string[];
}
```

```typescript [GetCharLorebooksOption]
interface GetCharLorebooksOption {
  name?: string; // 要查询的角色卡名称；默认为当前角色卡
  type?: "all" | "primary" | "additional"; // 按角色世界书的绑定类型筛选世界书；默认为 'all'
}
```

:::

### 参数

#### `name?`

- **类型**: `string`
- **描述**: 要查询的角色卡名称；默认为当前角色卡

#### `type?`

- **类型**: `"all" | "primary" | "additional"`
- **描述**: 按角色世界书的绑定类型筛选世界书；默认为 `"all"`

### 返回值

- **CharLorebooks 对象**: `{ primary: string | null; additional: string[]; }` - 主要世界书名称和附加世界书名称列表

### 示例

:::code-group
```typescript [获取当前角色卡绑定的所有世界书]
const lorebooks = getCharLorebooks();
```
```typescript [获取当前角色卡绑定的主要世界书]
const lorebooks = getCharLorebooks({ type: "primary" });
console.log(lorebooks.primary);
```
:::

## getCurrentCharPrimaryLorebook

获取当前角色卡绑定的主要世界书。

```typescript
function getCurrentCharPrimaryLorebook(): string | null;
```

### 返回值

- **主要世界书名称**: `string | null` - 如果当前角色卡有绑定并使用世界书 (地球图标呈绿色), 返回该世界书的名称；否则返回 `null`

## getChatLorebook

获取当前聊天绑定的世界书。

```typescript
async function getChatLorebook(): Promise<string | null>;
```

### 返回值

- **聊天世界书名称**: `string | null` - 当前聊天绑定的世界书名称，或 null 表示没有绑定世界书

## setChatLorebook

设置当前聊天绑定的世界书。

```typescript
async function setChatLorebook(lorebook: string | null): Promise<void>;
```

### 参数

#### `lorebook`

- **类型**: `string | null`
- **描述**: 世界书名称，或 null 表示移除世界书

## getOrCreateChatLorebook

获取或创建当前聊天绑定的世界书。

```typescript
async function getOrCreateChatLorebook(lorebook?: string): Promise<string>;
```

### 参数

#### `lorebook?`

- **类型**: `string`
- **描述**: 可选参数，指定世界书名称；如果未指定，则根据聊天文件名自动生成一个世界书名称

### 返回值

- **聊天世界书名称**: `string`


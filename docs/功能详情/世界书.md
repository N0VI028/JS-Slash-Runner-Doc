# 世界书

<CustomTOC />

## getLorebookSettings

获取当前的世界书全局设置。

:::code-group

```typescript [getLorebookSettings]
async function getLorebookSettings(): Promise<LorebookSettings>;
```

```typescript [LorebookSettings]
interface LorebookSettings {
  selected_global_lorebooks: string[];

  scan_depth: number;
  context_percentage: number;
  budget_cap: number; // 0 表示禁用
  min_activations: number;
  max_depth: number; // 0 表示无限制
  max_recursion_steps: number;

  include_names: boolean;
  recursive: boolean;
  case_sensitive: boolean;
  match_whole_words: boolean;
  use_group_scoring: boolean;
  overflow_alert: boolean;

  insertion_strategy: "evenly" | "character_first" | "global_first";
}
```

:::

### 返回值

- **selected_global_lorebooks**: `string[]`
- **scan_depth**: `number`
- **context_percentage**: `number`
- **budget_cap**: `number`
- **min_activations**: `number`
- **max_depth**: `number`
- **max_recursion_steps**: `number`
- **include_names**: `boolean`
- **recursive**: `boolean`
- **case_sensitive**: `boolean`
- **match_whole_words**: `boolean`
- **use_group_scoring**: `boolean`
- **overflow_alert**: `boolean`
- **insertion_strategy**: `"evenly" | "character_first" | "global_first"`

### 示例

```typescript
// 获取全局启用的世界书
const settings = await getLorebookSettings();
alert(settings.selected_global_lorebooks);
```

## setLorebookSettings

修改世界书全局设置。

```typescript
async function setLorebookSettings(
  settings: Partial<LorebookSettings>
): Promise<void>;
```

### 参数

#### `settings`

- **类型**: [`Partial<LorebookSettings>`](./世界书#返回值)
- **描述**: 要修改的世界书设置

:::warning
`setLorebookSettings` 因为酒馆问题很慢，建议先 `getLorebookSetting`, 进行比较，再 `setLorebookSettings`
:::

### 示例

:::code-group

```typescript [修改上下文百分比为 100%, 启用递归扫描]
await setLorebookSettings({ context_percentage: 100, recursive: true });
```

```typescript [优化性能的写法]
const expected_settings = {
  /*预期设置*/
};
const settings = await getLorebookSettings();
if (_.isEqual(_.merge({}, settings, expected_settings), settings)) {
  setLorebookSettings(expected_settings);
}
```

:::

## getCharLorebooks

获取角色卡绑定的世界书。

:::code-group

```typescript [getCharLorebooks]
async function getCharLorebooks(
  option: GetCharLorebooksOption = {}
): Promise<CharLorebook[]>;
```

```typescript [CharLorebook]
interface CharLorebook {
  name: string;
  type: "primary" | "additional";
}
```

```typescript [GetCharLorebooksOption]
interface GetCharLorebooksOption {
  name?: string; // 要查询的角色卡名称；默认为当前角色卡
  type?: "all" | "primary" | "additional"; // 按角色世界书的绑定类型筛选世界书；默认为 'all'
}
```

:::

### 参数

#### `name?`

- **类型**: `string`
- **描述**: 要查询的角色卡名称；默认为当前角色卡

#### `type?`

- **类型**: `"all" | "primary" | "additional"`
- **描述**: 按角色世界书的绑定类型筛选世界书；默认为 `"all"`

### 返回值

- **CharLorebook 数组**: [`CharLorebook[]`](./世界书#charlorebook)

### 示例

```typescript
// 获取当前角色卡绑定的所有世界书
const lorebooks = await getCharLorebooks();

// 获取当前角色卡绑定的主要世界书
const primaryLorebook = await getCharLorebooks({ type: "primary" });
```

## getCurrentCharPrimaryLorebook

获取当前角色卡绑定的主要世界书。

```typescript
async function getCurrentCharPrimaryLorebook(): Promise<string | null>;
```

### 返回值

- **主要世界书名称**: `string | null` - 如果当前角色卡有绑定并使用世界书 (地球图标呈绿色), 返回该世界书的名称；否则返回 `null`

## getOrCreateChatLorebook

获取或创建当前聊天绑定的世界书。

```typescript
async function getOrCreateChatLorebook(): Promise<string>;
```

### 返回值

- **聊天世界书名称**: `string`

## getLorebooks

获取世界书列表。

```typescript
async function getLorebooks(): Promise<string[]>;
```

### 返回值

- **世界书名称列表**: `string[]`

## createLorebook

新建世界书。

```typescript
async function createLorebook(lorebook: string): Promise<boolean>;
```

### 参数

#### `lorebook`

- **类型**: `string`
- **描述**: 世界书名称

### 返回值

- **是否成功创建**: `boolean` - 如果已经存在同名世界书会失败

## deleteLorebook

删除世界书。

```typescript
async function deleteLorebook(lorebook: string): Promise<boolean>;
```

### 参数

#### `lorebook`

- **类型**: `string`
- **描述**: 世界书名称

### 返回值

- **是否成功删除**: `boolean` - 可能因世界书不存在等原因而失败

## getLorebookEntries

获取世界书中的条目信息。

:::code-group

```typescript [getLorebookEntries]
async function getLorebookEntries(
  lorebook: string,
  option: GetLorebookEntriesOption = {}
): Promise<LorebookEntry[]>;
```

```typescript [GetLorebookEntriesOption]
interface GetLorebookEntriesOption {
  filter?: "none" | Partial<LorebookEntry>; // 按照指定字段值筛选条目
}
```

```typescript [LorebookEntry]
interface LorebookEntry {
  uid: number; // uid 是相对于世界书内部的，不要跨世界书使用
  display_index: number; // 酒馆中将排序设置为 "自定义" 时的显示顺序

  comment: string;
  enabled: boolean;
  type: "constant" | "selective" | "vectorized";
  position:
    | "before_character_definition" // 角色定义之前
    | "after_character_definition" // 角色定义之后
    | "before_example_messages" // 示例消息之前
    | "after_example_messages" // 示例消息之后
    | "before_author_note" // 作者注释之前
    | "after_author_note" // 作者注释之后
    | "at_depth_as_system" // @D⚙
    | "at_depth_as_assistant" // @D👤
    | "at_depth_as_user"; // @D🤖
  depth: number | null; // 仅对于 `position === 'at_depth_as_???'` 有意义；其他情况为 null
  order: number;
  probability: number;

  key: string[];
  logic: "and_any" | "and_all" | "not_all" | "not_any";
  filter: string[];

  scan_depth: "same_as_global" | number;
  case_sensitive: "same_as_global" | boolean;
  match_whole_words: "same_as_global" | boolean;
  use_group_scoring: "same_as_global" | boolean;
  automation_id: string | null;

  exclude_recursion: boolean;
  prevent_recursion: boolean;
  delay_until_recursion: boolean | number; // 启用则是 true, 如果设置了具体的 Recursion Level 则是数字

  content: string;

  group: string;
  group_prioritized: boolean;
  group_weight: number;
  sticky: number | null;
  cooldown: number | null;
  delay: number | null;
}
```

:::

### 参数

#### `lorebook`

- **类型**: `string`
- **描述**: 世界书名称

#### `filter?`

- **类型**: `"none" | Partial<LorebookEntry>`
- **描述**: 按照指定字段值筛选条目，要求对应字段值包含制定的内容；默认为不进行筛选.如 `{content: '神乐光'}` 表示内容中必须有 `'神乐光'`, `{type: 'selective'}` 表示仅获取绿灯条目.
  - `"none"`: 不筛选
  - `Partial<LorebookEntry>`: 按照指定字段值筛选条目，详见 [`LorebookEntry`](./世界书#getlorebookentries)

:::warning
由于实现限制，只能做到简单筛选；如果需要更复杂的筛选，请获取所有条目然后自己筛选。
:::

### 示例

:::code-group

```typescript [获取所有条目]
// 获取世界书中所有条目的所有信息
const entries = await getLorebookEntries("eramgt少女歌剧");
```

```typescript [按内容筛选]
// 按内容筛选，content 中必须出现 `'神乐光'`
const entries = await getLorebookEntries("eramgt少女歌剧", {
  filter: { content: "神乐光" },
});
```

:::

## setLorebookEntries

修改世界书中的条目信息。

```typescript
async function setLorebookEntries(
  lorebook: string,
  entries: (Pick<LorebookEntry, "uid"> & Partial<Omit<LorebookEntry, "uid">>)[]
): Promise<void>;
```

### 参数

#### `lorebook`

- **类型**: `string`
- **描述**: 条目所在的世界书名称

#### `entries`

- **类型**: [`(Pick<LorebookEntry, "uid"> & Partial<Omit<LorebookEntry, "uid">>)[]`](./世界书#getlorebookentries)
- **描述**: 要修改的条目信息数组。其中必须有 "uid"，而其他字段可选

:::warning
这只是修改信息，不能创建新的条目，因此要求条目必须已经在世界书中。
:::

### 示例

:::code-group

```typescript [禁止所有条目递归，保持其他设置不变]
const lorebook = "eramgt少女歌剧";
const entries = await getLorebookEntries(lorebook);
await setLorebookEntries(
  lorebook,
  entries.map((entry) => ({
    uid: entry.uid,
    prevent_recursion: true,
  }))
);
```

```typescript [反转所有条目的递归开关]
const lorebook = "eramgt少女歌剧";
const entries = await getLorebookEntries(lorebook);
await setLorebookEntries(
  lorebook,
  entries.map((entry) => ({
    uid: entry.uid,
    prevent_recursion: !entry.prevent_recursion,
  }))
);
```

:::

## createLorebookEntry

向世界书中新增条目。

```typescript
async function createLorebookEntry(
  lorebook: string,
  field_values: Partial<Omit<LorebookEntry, "uid">>
): Promise<number>;
```

### 参数

#### `lorebook`

- **类型**: `string`
- **描述**: 世界书名称

#### `field_values`

- **类型**: [`Partial<Omit<LorebookEntry, "uid">>`](./世界书#getlorebookentries)
- **描述**: 要对新条目设置的字段值，如果不设置则采用酒馆给的默认值

### 返回值

- **新条目的 uid**: `number`

### 示例

```typescript
const uid = await createLorebookEntry("eramgt少女歌剧", {
  comment: "revue",
  content: "歌唱吧跳舞吧相互争夺吧",
});
```

## deleteLorebookEntry

删除世界书中的某个条目。

```typescript
async function deleteLorebookEntry(
  lorebook: string,
  uid: number
): Promise<boolean>;
```

### 参数

#### `lorebook`

- **类型**: `string`
- **描述**: 世界书名称

#### `uid`

- **类型**: `number`
- **描述**: 要删除的条目 uid

### 返回值

- **是否成功删除**: `boolean` - 可能因世界书不存在、对应条目不存在等原因失败

---
order: 6
---

# 酒馆助手宏

:::tip
请务必先阅读[如何正确使用酒馆助手](/guide/基本用法/如何正确使用酒馆助手.md)
:::

酒馆虽然有宏 (<code v-pre>{{user}}</code>、<code v-pre>{{char}}</code>、<code v-pre>{{getvar::变量}}</code>) 来在显示或提示词中表达一些占位内容, 但扩展很难通过它注册带参数的宏如 <code v-pre>{{get_message_variable::变量}}</code> 等.

酒馆助手为此自行提供了酒馆助手宏, 它虽然存在一些局限性, 但能满足大部分需求.

[点击查看对应类型定义文件 (可发给 AI 或 IDE 使用, 酒馆助手界面中提供了打包下载)](https://github.com/N0VI028/JS-Slash-Runner/blob/main/%40types/function/macro_like.d.ts)

<CustomTOC />

## 酒馆助手内置宏

酒馆助手内置了以下宏:

- <code v-pre>{{get_xxx_variable::变量}}</code>: 获取变量值并将其显示为一行 JSON 字符串
  - <code v-pre>{{get_global_variable::变量}}</code>: 从全局变量中获取路径 `变量` 下的值
  - <code v-pre>{{get_preset_variable::变量}}</code>: 从当前预设的变量中获取路径 `变量` 下的值
  - <code v-pre>{{get_character_variable::变量}}</code>: 从当前角色卡的变量中获取路径 `变量` 下的值
  - <code v-pre>{{get_chat_variable::变量}}</code>: 从当前聊天文件的变量中获取路径 `变量` 下的值
  - <code v-pre>{{get_message_variable::变量}}</code>: 从最新消息楼层变量中获取路径 `变量` 下的值
- <code v-pre>{{format_xxx_message::变量}}</code>: 获取消息内容并将其显示为格式化后的 YAML 块
  - `xxx` 可用类型与 <code v-pre>{{get_xxx_variable::变量}}</code> 相同

例如, 在一些变量框架示例中, 你会使用 <code v-pre>{{get_message_variable::stat_data}}</code> 来获取路径 `stat_data` 下的值来发给 AI.

## 禁用酒馆助手宏

通过 "酒馆助手主界面-禁用酒馆助手宏", 你可以禁用酒馆助手宏, 从而将 <code v-pre>{{get_message_variable::stat_data}}</code> 原封不动地显示和发送给 AI.

![禁用酒馆助手宏](/禁用酒馆助手宏.png)

## registerMacroLike

注册一个新的助手宏

:::code-group

```ts [registerMacroLike]
function registerMacroLike(
  regex: RegExp,
  replace: (context: Context, substring: string, ...args: any[]) => string,
): void;
```

```ts [MacroLikeContext]
type MacroLikeContext = {
  message_id?: number;
  role?: 'user' | 'assistant' | 'system';
}
```

:::

### 参数

#### `regex`

- **类型**: `RegExp`
- **描述**: 匹配的正则表达式

#### `replace`

- **类型**: `(context: Context, substring: string, ...args: any[]) => string`
- **描述**: 针对匹配到的文本所要进行的替换, 其返回值将会是替换结果

### 示例

:::code-group

```ts [注册一个统计行数的宏]
registerMacros(
  /<count_lines>(.*?)<count_lines>/gi,
  context => content.split('\n').length
);
```

:::

## registerMacroLike

取消注册一个助手宏

:::code-group

```ts [registerMacroLike]
declare function unregisterMacroLike(regex: RegExp): void;
```

:::

### 参数

#### `regex`

- **类型**: `RegExp`
- **描述**: 助手宏的正则表达式
